name: Build CatSeedLogin Plugin

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  CARGO_NET_GIT_FETCH_WITH_CLI: true
  RUSTFLAGS: "-A warnings"

jobs:
  get-version:
    name: Get Version and Commit Info
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      commit_message: ${{ steps.get-commit-info.outputs.commit_message }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1  # åªè·å–æœ€è¿‘ä¸€æ¬¡æäº¤
    
    - name: Extract version from Cargo.toml
      id: get-version
      shell: bash
      run: |
        # ä»Cargo.tomlæ–‡ä»¶ä¸­æå–ç‰ˆæœ¬å·
        if [ -f "Cargo.toml" ]; then
          VERSION=$(grep -E '^version\s*=' Cargo.toml | head -1 | cut -d'"' -f2)
          echo "ä»Cargo.tomlä¸­æå–çš„ç‰ˆæœ¬å·: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        else
          echo "é”™è¯¯: æœªæ‰¾åˆ°Cargo.tomlæ–‡ä»¶"
          exit 1
        fi
    
    - name: Get latest commit message
      id: get-commit-info
      shell: bash
      run: |
        # è·å–æœ€è¿‘ä¸€æ¬¡æäº¤ä¿¡æ¯
        COMMIT_MESSAGE=$(git log -1 --pretty=%B)
        echo "æœ€è¿‘ä¸€æ¬¡æäº¤ä¿¡æ¯: $COMMIT_MESSAGE"
        echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT

  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: get-version
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: windows
            file_extension: dll
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux
            file_extension: so
          - os: macos-latest
            target: x86_64-apple-darwin
            platform: macos
            file_extension: dylib
      fail-fast: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1  # åªè·å–æœ€è¿‘ä¸€æ¬¡æäº¤

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: ${{ matrix.target }}
        profile: minimal

    - name: Add Rust target
      run: rustup target add ${{ matrix.target }}

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Build release
      run: cargo build --release --target ${{ matrix.target }}

    - name: Find library file
      shell: bash
      run: |
        # æŸ¥æ‰¾æ„å»ºå‡ºçš„åº“æ–‡ä»¶
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          LIB_FILE=$(find target/${{ matrix.target }}/release -name "*.dll" -type f | head -1)
        elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          LIB_FILE=$(find target/${{ matrix.target }}/release -name "*.so" -type f | head -1)
        else
          LIB_FILE=$(find target/${{ matrix.target }}/release -name "*.dylib" -type f | head -1)
        fi
        
        if [ -z "$LIB_FILE" ]; then
          echo "âŒ æœªæ‰¾åˆ°åº“æ–‡ä»¶ï¼Œæ£€æŸ¥æ‰€æœ‰æ–‡ä»¶:"
          find target/${{ matrix.target }}/release -type f
          exit 1
        fi
        
        echo "âœ… æ‰¾åˆ°åº“æ–‡ä»¶: $LIB_FILE"
        
        # å‡†å¤‡æ–‡ä»¶å
        VERSION="${{ needs.get-version.outputs.version }}"
        ARTIFACT_NAME="CatSeedLogin_v${VERSION}_${{ matrix.platform }}.${{ matrix.file_extension }}"
        
        mkdir -p dist
        cp "$LIB_FILE" "dist/$ARTIFACT_NAME"
        echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_ENV
        echo "version=$VERSION" >> $GITHUB_ENV

    - name: Upload to CI Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CatSeedLogin-v${{ env.version }}-${{ matrix.platform }}
        path: dist/${{ env.artifact_name }}
        retention-days: 90

  create-summary:
    name: Create Build Summary
    runs-on: ubuntu-latest
    needs: [get-version, build]
    if: always()
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        pattern: CatSeedLogin-*
        merge-multiple: true

    - name: Create summary
      shell: bash
      run: |
        VERSION="${{ needs.get-version.outputs.version }}"
        COMMIT_MESSAGE="${{ needs.get-version.outputs.commit_message }}"
        
        echo "# ğŸ± CatSeedLogin v${VERSION} æ„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“‹ æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **ç‰ˆæœ¬**: v${VERSION}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ„å»ºæ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤**: ${GITHUB_SHA:0:7}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ”§ æ›´æ–°å†…å®¹" >> $GITHUB_STEP_SUMMARY
        echo "åŸºäºæœ€è¿‘ä¸€æ¬¡æäº¤: $COMMIT_MESSAGE" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ“¦ ä¸‹è½½é“¾æ¥" >> $GITHUB_STEP_SUMMARY
        echo "æ„ä»¶å·²ä¸Šä¼ è‡³ GitHub Actions Artifactsï¼Œå¯åœ¨å³ä¾§ã€ŒArtifactsã€åŒºåŸŸä¸‹è½½ï¼š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥å„å¹³å°æ„å»ºç»“æœ
        echo "### å¯ç”¨å¹³å°:" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥Windowsæ–‡ä»¶
        if ls ./artifacts/CatSeedLogin_v${VERSION}_windows.dll 1> /dev/null 2>&1; then
          echo "- âœ… Windows (x64) - CatSeedLogin_v${VERSION}_windows.dll" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ Windows æ„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æ£€æŸ¥Linuxæ–‡ä»¶
        if ls ./artifacts/CatSeedLogin_v${VERSION}_linux.so 1> /dev/null 2>&1; then
          echo "- âœ… Linux (x64) - CatSeedLogin_v${VERSION}_linux.so" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ Linux æ„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æ£€æŸ¥macOSæ–‡ä»¶
        if ls ./artifacts/CatSeedLogin_v${VERSION}_macos.dylib 1> /dev/null 2>&1; then
          echo "- âœ… macOS (x64) - CatSeedLogin_v${VERSION}_macos.dylib" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ macOS æ„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸš€ ä½¿ç”¨è¯´æ˜" >> $GITHUB_STEP_SUMMARY
        echo "1. ä¸‹è½½å¯¹åº”å¹³å°çš„åº“æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "2. å°†æ–‡ä»¶æ”¾å…¥ Pumpkin æœåŠ¡å™¨çš„ plugins ç›®å½•" >> $GITHUB_STEP_SUMMARY
        echo "3. é‡å¯æœåŠ¡å™¨" >> $GITHUB_STEP_SUMMARY
        
        # åŒæ—¶è¾“å‡ºåˆ°æ—¥å¿—
        echo "æ„å»ºå®Œæˆ: CatSeedLogin v${VERSION}"
        echo "æœ€è¿‘ä¸€æ¬¡æäº¤: ${COMMIT_MESSAGE}"

    - name: Upload summary as artifact
      uses: actions/upload-artifact@v4
      with:
        name: build-summary-v${{ needs.get-version.outputs.version }}
        path: $GITHUB_STEP_SUMMARY
        retention-days: 30
